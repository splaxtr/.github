name: ðŸ·ï¸ SÃ¼rÃ¼m TaslaÄŸÄ± OluÅŸtur

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [closed]
    branches:
      - main
  schedule:
    - cron: '0 10 * * 1'  # Her Pazartesi 10:00'da (UTC)
  workflow_dispatch:  # Manuel tetikleme iÃ§in

env:
  CONFIG_PATH: '.github/release-drafter.yml'

jobs:
  update_release_draft:
    name: ðŸ“¦ SÃ¼rÃ¼m TaslaÄŸÄ±nÄ± GÃ¼ncelle
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # Gerekli izinler
    permissions:
      contents: write
      pull-requests: read
    
    # Sadece merge edilmiÅŸ PR'lar iÃ§in Ã§alÄ±ÅŸsÄ±n
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
      - name: ðŸ“¥ Repository'yi Ã‡ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # TÃ¼m commit geÃ§miÅŸini al
          token: ${{ secrets.GITHUB_TOKEN }}
        timeout-minutes: 2

      - name: ðŸ” Release Drafter Config KontrolÃ¼
        id: check-config
        timeout-minutes: 1
        run: |
          if [ -f "${{ env.CONFIG_PATH }}" ]; then
            echo "âœ… Release drafter config dosyasÄ± bulundu"
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Release drafter config dosyasÄ± bulunamadÄ±: ${{ env.CONFIG_PATH }}"
            echo "config_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ·ï¸ SÃ¼rÃ¼m TaslaÄŸÄ±nÄ± GÃ¼ncelle
        if: steps.check-config.outputs.config_exists == 'true'
        uses: release-drafter/release-drafter@v5
        with:
          config-name: release-drafter.yml
          disable-autolabeler: false
          name: 'v{{ env.NEXT_RELEASE }}'  # Otomatik sÃ¼rÃ¼m ismi
          tag: 'v{{ env.NEXT_RELEASE }}'
          version: '{{ env.NEXT_RELEASE }}'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        timeout-minutes: 5

      - name: ðŸ“Š SÃ¼rÃ¼m Durumunu Raporla
        if: always()
        timeout-minutes: 2
        run: |
          echo "## ðŸ·ï¸ SÃ¼rÃ¼m TaslaÄŸÄ± Durumu" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            if [ "${{ steps.check-config.outputs.config_exists }}" = "true" ]; then
              echo "âœ… **Durum:** SÃ¼rÃ¼m taslaÄŸÄ± baÅŸarÄ±yla gÃ¼ncellendi" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“… **TetiklendiÄŸi iÃ§in:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
              
              if [ "${{ github.event_name }}" == "schedule" ]; then
                echo "â° **Tip:** ZamanlanmÄ±ÅŸ gÃ¼ncelleme" >> $GITHUB_STEP_SUMMARY
              elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                echo "ðŸ‘¤ **Tip:** Manuel tetikleme" >> $GITHUB_STEP_SUMMARY
              elif [ "${{ github.event_name }}" == "push" ]; then
                echo "ðŸ”€ **Tip:** Branch push" >> $GITHUB_STEP_SUMMARY
                echo "ðŸŒ¿ **Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
              elif [ "${{ github.event_name }}" == "pull_request" ]; then
                echo "ðŸŽ¯ **Tip:** PR merge" >> $GITHUB_STEP_SUMMARY
                echo "ðŸ“ **PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ **Durum:** Config dosyasÄ± bulunamadÄ±" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“ **Aranan Config:** ${{ env.CONFIG_PATH }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Durum:** SÃ¼rÃ¼m taslaÄŸÄ± gÃ¼ncellenemedi" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” **Sebep:** Ä°ÅŸlem baÅŸarÄ±sÄ±z oldu" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ã‡alÄ±ÅŸtÄ±ran:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Ã‡alÄ±ÅŸma ZamanÄ±:** $(date +'%d.%m.%Y %H:%M:%S')" >> $GITHUB_STEP_SUMMARY

  # SÃ¼rÃ¼m doÄŸrulama iÅŸi (opsiyonel)
  validate_release:
    name: âœ… SÃ¼rÃ¼m DoÄŸrulama
    runs-on: ubuntu-latest
    needs: update_release_draft
    if: always() && needs.update_release_draft.result == 'success'
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“‹ Draft Release'leri Listele
        timeout-minutes: 3
        run: |
          echo "## ðŸ“‹ Mevcut Draft Release'ler" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          DRAFTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases" | \
            jq -r '.[] | select(.draft == true) | "| \(.name) | \(.tag_name) | \(.created_at) |"')
          
          if [ -n "$DRAFTS" ]; then
            echo "| Ä°sim | Tag | OluÅŸturulma Tarihi |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|-------------------|" >> $GITHUB_STEP_SUMMARY
            echo "$DRAFTS" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  HenÃ¼z draft release bulunmuyor" >> $GITHUB_STEP_SUMMARY
          fi