name: â™»ï¸ Reusable Python CI Workflow

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version to use (default: 3.11)"
        required: false
        default: "3.11"
      working-directory:
        description: "Directory where the Python project is located"
        required: false
        default: "."
      run-tests:
        description: "Run tests (true/false)"
        required: false
        default: true
      docker-build:
        description: "Build and test inside Docker (true/false)"
        required: false
        default: true
    secrets:
      PYPI_TOKEN:
        required: false

jobs:
  python-ci:
    name: Python CI (${{ inputs.working-directory }})
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      # ğŸ§¹ 1. Kaynak Kodun Ä°ndirilmesi
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ§± 2. Python Kurulumu
      - name: Setup Python ${{ inputs.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: "pip"

      # ğŸ“¦ 3. Gerekli BaÄŸÄ±mlÄ±lÄ±klarÄ±n Kurulumu
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest black ruff

      # ğŸ§¹ 4. Kod Kalitesi Kontrolleri
      - name: Run lint and format checks
        run: |
          echo "ğŸ” Running code checks..."
          ruff check .
          black --check .

      # ğŸ§ª 5. Testlerin Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±
      - name: Run pytest
        if: ${{ inputs.run-tests == 'true' }}
        run: |
          echo "ğŸ§ª Running tests..."
          pytest -v --maxfail=3 --disable-warnings --cov=. --cov-report=term-missing

      # ğŸ³ 6. Docker Image OluÅŸturma
      - name: Build Docker image
        if: ${{ inputs.docker-build == 'true' }}
        run: |
          echo "ğŸ³ Building Docker image..."
          docker build -t example-python:${{ github.sha }} .

      # ğŸ§¾ 7. Docker Container Testi
      - name: Test Docker container
        if: ${{ inputs.docker-build == 'true' }}
        run: |
          echo "âœ… Verifying Docker container..."
          docker run --rm example-python:${{ github.sha }} python --version

      # ğŸ“¤ 8. Test RaporlarÄ±nÄ±n Kaydedilmesi
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report-${{ github.sha }}
          path: .pytest_cache/

      # ğŸ“¦ 9. Build Artifacts
      - name: Upload build artifacts
        if: ${{ always() && hashFiles('dist/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: python-build-${{ github.sha }}
          path: dist/

      # ğŸ§¾ 10. Ã–zet Bilgi
      - name: Build Summary
        run: |
          echo "âœ… Python Version: $(python --version)"
          echo "ğŸ“¦ Installed Packages:"
          pip list
          echo "ğŸ“ Working Directory: ${{ inputs.working-directory }}"
          echo "ğŸ CI pipeline completed successfully."
