name: ðŸš€ Production'a DaÄŸÄ±tÄ±m

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'DaÄŸÄ±tÄ±m OrtamÄ±'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_deploy:
        description: 'Zorla DaÄŸÄ±tÄ±m'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  GO_VERSION: '1.21'
  FLUTTER_VERSION: '3.13.x'
  BUN_VERSION: 'latest'

# Workflow seviyesinde timeout
timeout-minutes: 90

jobs:
  # --------------------
  # Validation & Setup
  # --------------------
  validate:
    name: ðŸ” Deploy Validasyonu
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      should_deploy: ${{ steps.check-changes.outputs.should_deploy }}
      changed_services: ${{ steps.check-changes.outputs.changed_services }}
    
    steps:
      - name: ðŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” DeÄŸiÅŸiklikleri Kontrol Et
        id: check-changes
        timeout-minutes: 3
        run: |
          echo "Servis dizinlerindeki deÄŸiÅŸiklikler kontrol ediliyor..."
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "DeÄŸiÅŸen dosyalar: $CHANGED_FILES"
          
          # Hangi servislerin deÄŸiÅŸtiÄŸini tespit et
          CHANGED_SERVICES=""
          if echo "$CHANGED_FILES" | grep -q "backend/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES,backend"
          fi
          if echo "$CHANGED_FILES" | grep -q "frontend/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES,frontend"
          fi
          if echo "$CHANGED_FILES" | grep -q "mobile/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES,mobile"
          fi
          if echo "$CHANGED_FILES" | grep -q "bots/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES,bots"
          fi
          
          # Ä°lk virgÃ¼lÃ¼ kaldÄ±r
          CHANGED_SERVICES=${CHANGED_SERVICES#,}
          
          if [ -n "$CHANGED_SERVICES" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "changed_services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
            echo "ðŸš€ Deploy edilecek servisler: $CHANGED_SERVICES"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "changed_services=" >> $GITHUB_OUTPUT
            echo "âš ï¸  Deploy gerektiren deÄŸiÅŸiklik yok"
          fi

  # --------------------
  # Backend (Go) Deploy
  # --------------------
  deploy-backend:
    name: ðŸ¹ Backend Deploy
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true' && contains(needs.validate.outputs.changed_services, 'backend')
    environment: production
    timeout-minutes: 25
    
    steps:
      - name: ðŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ðŸ¹ Go Kur
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ./backend/go.sum

      - name: ðŸ§ª Go Test
        timeout-minutes: 5
        run: |
          cd backend
          go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: ðŸ—ï¸ Go Build
        timeout-minutes: 3
        run: |
          cd backend
          CGO_ENABLED=0 go build -ldflags="-s -w" -o example-backend ./cmd/server

      - name: ðŸ”’ GÃ¼venlik TaramasÄ±
        timeout-minutes: 5
        run: |
          cd backend
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec ./...

      - name: ðŸ“¦ Backend Deploy
        timeout-minutes: 10
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
          DEPLOY_TOKEN: ${{ secrets.BACKEND_DEPLOY_TOKEN }}
        run: |
          echo "ðŸš€ Backend production'a deploy ediliyor..."
          if [ -n "$DEPLOY_TOKEN" ] && [ -n "$KUBECONFIG" ]; then
            # Kubernetes deploy
            kubectl set image deployment/example-backend \
              example-backend=ghcr.io/example-inc/backend:${{ github.sha }} \
              -n example-production
            
            kubectl rollout status deployment/example-backend -n example-production --timeout=300s
            echo "âœ… Backend baÅŸarÄ±yla deploy edildi"
          else
            echo "âš ï¸  Deploy token veya KUBECONFIG bulunamadÄ±, gerÃ§ek deploy atlanÄ±yor"
          fi

  # --------------------
  # Frontend (Bun/Next.js) Deploy
  # --------------------
  deploy-frontend:
    name: ðŸŒ Frontend Deploy
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true' && contains(needs.validate.outputs.changed_services, 'frontend')
    environment: production
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ðŸ“¦ Bun Kur
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ðŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± Ä°ndir
        timeout-minutes: 3
        run: bun install --frozen-lockfile
        working-directory: ./frontend

      - name: ðŸ” TypeScript KontrolÃ¼
        timeout-minutes: 2
        run: bun run type-check
        working-directory: ./frontend

      - name: ðŸ§ª Test
        timeout-minutes: 3
        run: bun run test
        working-directory: ./frontend

      - name: ðŸ—ï¸ Build
        timeout-minutes: 5
        run: bun run build
        working-directory: ./frontend

      - name: ðŸŒ Frontend Deploy
        timeout-minutes: 5
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ðŸš€ Frontend production'a deploy ediliyor..."
          if [ -n "$VERCEL_TOKEN" ]; then
            # Vercel deploy
            npx vercel --prod --token=$VERCEL_TOKEN --confirm
            echo "âœ… Frontend baÅŸarÄ±yla deploy edildi"
          else
            echo "âš ï¸  Vercel token bulunamadÄ±, gerÃ§ek deploy atlanÄ±yor"
          fi
        working-directory: ./frontend

  # --------------------
  # Mobile (Flutter) Deploy
  # --------------------
  deploy-mobile:
    name: ðŸ“± Mobil Build
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true' && contains(needs.validate.outputs.changed_services, 'mobile')
    environment: production
    timeout-minutes: 45
    
    steps:
      - name: ðŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ðŸ“± Flutter Kur
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-app-${{ hashFiles('**/pubspec.lock') }}
          cache-path: ./mobile/.dart_tool

      - name: ðŸ“¦ Paketleri Getir
        timeout-minutes: 5
        run: flutter pub get
        working-directory: ./mobile

      - name: ðŸ§ª Test
        timeout-minutes: 5
        run: flutter test
        working-directory: ./mobile

      - name: ðŸ—ï¸ Android APK Build
        timeout-minutes: 15
        run: flutter build apk --release --split-per-abi
        working-directory: ./mobile

      - name: ðŸ—ï¸ iOS Build
        timeout-minutes: 20
        run: flutter build ios --release --no-codesign
        working-directory: ./mobile

      - name: ðŸ“¤ Store HazÄ±rlÄ±k
        timeout-minutes: 5
        env:
          DEPLOY_TOKEN: ${{ secrets.MOBILE_DEPLOY_TOKEN }}
        run: |
          echo "ðŸ“± Mobil uygulama store iÃ§in hazÄ±rlanÄ±yor..."
          if [ -n "$DEPLOY_TOKEN" ]; then
            # App Store, Google Play deploy hazÄ±rlÄ±ÄŸÄ±
            echo "Store deploy hazÄ±rlÄ±ÄŸÄ± yapÄ±lÄ±yor..."
            echo "âœ… Mobil build'ler baÅŸarÄ±yla oluÅŸturuldu"
          else
            echo "âš ï¸  Deploy token bulunamadÄ±, store upload atlanÄ±yor"
          fi
        working-directory: ./mobile

  # --------------------
  # Bots (Python/Node.js) Deploy
  # --------------------
  deploy-bots:
    name: ðŸ¤– BotlarÄ± Deploy Et
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true' && contains(needs.validate.outputs.changed_services, 'bots')
    environment: production
    timeout-minutes: 15
    
    strategy:
      matrix:
        bot-type: [python, node]
    
    steps:
      - name: ðŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ðŸ¤– Bot Deploy - ${{ matrix.bot-type }}
        timeout-minutes: 10
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
          DEPLOY_TOKEN: ${{ secrets.BOTS_DEPLOY_TOKEN }}
        run: |
          echo "ðŸš€ ${{ matrix.bot-type }} botlarÄ± deploy ediliyor..."
          if [ -n "$DEPLOY_TOKEN" ] && [ -n "$KUBECONFIG" ]; then
            kubectl set image deployment/example-bot-${{ matrix.bot-type }} \
              example-bot-${{ matrix.bot-type }}=ghcr.io/example-inc/bots-${{ matrix.bot-type }}:${{ github.sha }} \
              -n example-production
            
            kubectl rollout status deployment/example-bot-${{ matrix.bot-type }} -n example-production --timeout=180s
            echo "âœ… ${{ matrix.bot-type }} botlarÄ± baÅŸarÄ±yla deploy edildi"
          else
            echo "âš ï¸  Deploy token veya KUBECONFIG bulunamadÄ±, gerÃ§ek deploy atlanÄ±yor"
          fi

  # --------------------
  # Database Migration
  # --------------------
  database-migration:
    name: ðŸ—„ï¸ Database Migration
    runs-on: ubuntu-latest
    needs: [validate, deploy-backend]
    if: needs.validate.outputs.should_deploy == 'true' && contains(needs.validate.outputs.changed_services, 'backend')
    environment: production
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ðŸ¹ Go Kur
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: ðŸ—„ï¸ Migration Ã‡alÄ±ÅŸtÄ±r
        timeout-minutes: 8
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        run: |
          cd backend
          go run cmd/migrate/main.go
          echo "âœ… Database migration baÅŸarÄ±yla tamamlandÄ±"

      - name: âœ… Migration KontrolÃ¼
        timeout-minutes: 3
        run: |
          curl -f https://api.example.com/health/db || exit 1
          echo "âœ… Database health check baÅŸarÄ±lÄ±"

  # --------------------
  # Smoke Tests
  # --------------------
  smoke-tests:
    name: ðŸ§ª Smoke Testler
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, deploy-bots]
    if: always() && needs.validate.outputs.should_deploy == 'true'
    environment: production
    timeout-minutes: 10
    
    steps:
      - name: ðŸ§ª API Testleri
        timeout-minutes: 3
        run: |
          echo "ðŸ§ª API servisleri test ediliyor..."
          curl -f https://api.example.com/health || exit 1
          curl -f https://api.example.com/v1/status || exit 1
          echo "âœ… API testleri baÅŸarÄ±lÄ±"

      - name: ðŸ§ª Frontend Testleri
        timeout-minutes: 3
        run: |
          echo "ðŸ§ª Frontend servisleri test ediliyor..."
          curl -f https://example.com/ || exit 1
          curl -f https://example.com/api/health || exit 1
          echo "âœ… Frontend testleri baÅŸarÄ±lÄ±"

      - name: ðŸ§ª Bot Testleri
        timeout-minutes: 3
        run: |
          echo "ðŸ§ª Bot servisleri test ediliyor..."
          curl -f https://bots.example.com/health || exit 1
          echo "âœ… Bot testleri baÅŸarÄ±lÄ±"

  # --------------------
  # Notify & Summary
  # --------------------
  notify:
    name: ðŸ“¢ Deploy Ã–zeti
    runs-on: ubuntu-latest
    needs: 
      - validate
      - deploy-backend
      - deploy-frontend
      - deploy-mobile
      - deploy-bots
      - database-migration
      - smoke-tests
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“‹ Deploy Durumu Ã–zeti
        timeout-minutes: 3
        run: |
          echo "## ðŸš€ Example Production Deploy SonuÃ§larÄ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Servis | Durum | SÃ¼re |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Validasyon | ${{ needs.validate.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¹ Backend | ${{ needs.deploy-backend.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Frontend | ${{ needs.deploy-frontend.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± Mobil | ${{ needs.deploy-mobile.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– Botlar | ${{ needs.deploy-bots.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—„ï¸ Database Migration | ${{ needs.database-migration.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Smoke Testler | ${{ needs.smoke-tests.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**TetiklendiÄŸi iÃ§in:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**DeÄŸiÅŸen Servisler:** ${{ needs.validate.outputs.changed_services }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Deploy ZamanÄ±:** $(date +'%d.%m.%Y %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ **Toplam SÃ¼re:** $(( ( $(date +%s) - ${{ github.run_started_at }} ) / 60 )) dakika" >> $GITHUB_STEP_SUMMARY