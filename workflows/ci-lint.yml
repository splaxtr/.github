name: ğŸš€ CI - Lint ve Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Go iÃ§in lint ve test
  go-lint:
    name: ğŸ¹ Go Lint ve Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: ğŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ğŸ¹ Go Kur
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: ./backend/go.sum

      - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± Ä°ndir
        run: go mod download

      - name: ğŸ§¹ Go Format KontrolÃ¼
        run: test -z $(gofmt -l .)

      - name: ğŸ” Go Lint
        uses: golangci/golangci-lint-action@v3
        with:
          working-directory: ./backend
          version: latest

      - name: ğŸ§ª Go Test
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: ğŸ“Š Test KapsamÄ±
        run: |
          go tool cover -func=coverage.out
          total=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: $total%"
          if (( $(echo "$total < 80" | bc -l) )); then
            echo "âŒ Test coverage 80%'in altÄ±nda: $total%"
            exit 1
          fi

  # Frontend iÃ§in lint ve test
  frontend-lint:
    name: ğŸŒ Frontend Lint ve Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ğŸ“¦ Bun Kur
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± Ä°ndir
        run: bun install

      - name: ğŸ” TypeScript KontrolÃ¼
        run: bun run type-check

      - name: ğŸ§¹ ESLint
        run: bun run lint

      - name: ğŸ¨ Prettier KontrolÃ¼
        run: bun run format:check

      - name: ğŸ§ª Test
        run: bun run test

      - name: ğŸ—ï¸ Build
        run: bun run build

  # Python iÃ§in lint ve test
  python-lint:
    name: ğŸ Python Lint ve Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./bots/python
    
    steps:
      - name: ğŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ğŸ Python Kur
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ./bots/python/requirements.txt

      - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± Ä°ndir
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 pytest

      - name: ğŸ¨ Black Format KontrolÃ¼
        run: black --check .

      - name: ğŸ” Flake8 Lint
        run: flake8 .

      - name: ğŸ§ª Pytest
        run: pytest

  # Flutter iÃ§in lint ve test
  flutter-lint:
    name: ğŸ“± Flutter Lint ve Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile
    
    steps:
      - name: ğŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ğŸ“± Flutter Kur
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.x'
          cache: true
          cache-key: flutter-packages
          cache-path: ./mobile/.dart_tool

      - name: ğŸ“¦ Paketleri Getir
        run: flutter pub get

      - name: ğŸ” Dart Analyze
        run: flutter analyze

      - name: ğŸ¨ Dart Format KontrolÃ¼
        run: dart format --set-exit-if-changed .

      - name: ğŸ§ª Flutter Test
        run: flutter test

      - name: ğŸ—ï¸ Build
        run: flutter build apk --debug

  # GÃ¼venlik taramalarÄ±
  security-scan:
    name: ğŸ”’ GÃ¼venlik TaramasÄ±
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: ğŸ” Trivy GÃ¼venlik TaramasÄ±
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“¤ GÃ¼venlik SonuÃ§larÄ±nÄ± YÃ¼kle
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # SonuÃ§larÄ± birleÅŸtirme
  summary:
    name: ğŸ“Š SonuÃ§ Ã–zeti
    runs-on: ubuntu-latest
    needs: [go-lint, frontend-lint, python-lint, flutter-lint, security-scan]
    
    steps:
      - name: âœ… TÃ¼m Testler BaÅŸarÄ±lÄ±
        if: ${{ always() && contains(needs.*.result, 'failure') }}
        run: |
          echo "âŒ BazÄ± testler baÅŸarÄ±sÄ±z oldu"
          exit 1

      - name: ğŸ‰ TÃ¼m Testler BaÅŸarÄ±lÄ±
        if: ${{ always() && !contains(needs.*.result, 'failure') }}
        run: echo "âœ… TÃ¼m testler baÅŸarÄ±yla tamamlandÄ±"