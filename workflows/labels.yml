name: ðŸ·ï¸ Etiketleri Senkronize Et

on:
  push:
    branches: [main]
    paths: 
      - '.github/labels.yml'
      - '.github/workflows/labels.yml'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Test modunda Ã§alÄ±ÅŸtÄ±r (deÄŸiÅŸiklik yapma)'
        required: false
        default: false
        type: boolean

env:
  LABELS_FILE: '.github/labels.yml'

jobs:
  sync-labels:
    name: ðŸ”„ Etiketleri Senkronize Et
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    # Job seviyesinde timeout
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Repository'yi Ã‡ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ GitHub Etiketlerini Senkronize Et
        uses: crazy-max/ghaction-github-labeler@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          yaml-file: ${{ env.LABELS_FILE }}
          skip-delete: false
          dry-run: ${{ github.event.inputs.dry-run || false }}
          exclude: |
            .github/**/*
            README.md
            LICENSE

      - name: ðŸ“Š Etiket Durumunu Kontrol Et
        if: always()
        run: |
          echo "## ðŸ·ï¸ Etiket Senkronizasyon Durumu" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ã‡alÄ±ÅŸma Modu:** ${{ github.event.inputs.dry-run && 'Dry Run (Test)' || 'Production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Etiket DosyasÄ±:** ${{ env.LABELS_FILE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **Durum:** BaÅŸarÄ±lÄ±" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
              echo "â„¹ï¸ Dry run modunda Ã§alÄ±ÅŸtÄ±rÄ±ldÄ± - gerÃ§ek deÄŸiÅŸiklik yapÄ±lmadÄ±" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸŽ‰ Etiketler baÅŸarÄ±yla senkronize edildi" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Durum:** BaÅŸarÄ±sÄ±z" >> $GITHUB_STEP_SUMMARY
            echo "Hata detaylarÄ± iÃ§in loglarÄ± kontrol edin" >> $GITHUB_STEP_SUMMARY
          fi

  # Etiket kullanÄ±m istatistiklerini topla
  label-stats:
    name: ðŸ“ˆ Etiket Ä°statistikleri
    runs-on: ubuntu-latest
    needs: sync-labels
    if: always() && !github.event.inputs.dry-run
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Repository'yi Ã‡ek
        uses: actions/checkout@v4

      - name: ðŸ“Š Etiket Ä°statistiklerini Topla
        run: |
          echo "## ðŸ“Š Etiket Ä°statistikleri" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Toplam etiket sayÄ±sÄ±nÄ± hesapla
          TOTAL_LABELS=$(grep -c "^- name:" ${{ env.LABELS_FILE }} || true)
          echo "**Toplam Etiket SayÄ±sÄ±:** $TOTAL_LABELS" >> $GITHUB_STEP_SUMMARY
          
          # Kategori bazlÄ± sayÄ±lar
          echo "**Kategori DaÄŸÄ±lÄ±mÄ±:**" >> $GITHUB_STEP_SUMMARY
          TYPE_LABELS=$(grep -c "type:" ${{ env.LABELS_FILE }} || true)
          PRIORITY_LABELS=$(grep -c "priority:" ${{ env.LABELS_FILE }} || true)
          STATUS_LABELS=$(grep -c "status:" ${{ env.LABELS_FILE }} || true)
          COMPONENT_LABELS=$(grep -c "component:" ${{ env.LABELS_FILE }} || true)
          
          echo "- ðŸŽ« Type: $TYPE_LABELS" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš¨ Priority: $PRIORITY_LABELS" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ˆ Status: $STATUS_LABELS" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Component: $COMPONENT_LABELS" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Son GÃ¼ncelleme:** $(date +'%d.%m.%Y %H:%M')" >> $GITHUB_STEP_SUMMARY

  # Etiket doÄŸrulama
  validate-labels:
    name: âœ… Etiket DoÄŸrulama
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Repository'yi Ã‡ek
        uses: actions/checkout@v4

      - name: ðŸ” Etiket YapÄ±landÄ±rmasÄ±nÄ± DoÄŸrula
        run: |
          echo "## âœ… Etiket DoÄŸrulama" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # YAML syntax kontrolÃ¼
          if python3 -c "import yaml; yaml.safe_load(open('${{ env.LABELS_FILE }}'))"; then
            echo "âœ… YAML Syntax: GeÃ§erli" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ YAML Syntax: HatalÄ±" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Gerekli alanlarÄ± kontrol et
          if grep -q "name:" ${{ env.LABELS_FILE }} && grep -q "color:" ${{ env.LABELS_FILE }}; then
            echo "âœ… Gerekli Alanlar: Mevcut" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Gerekli Alanlar: Eksik" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Renk formatÄ± kontrolÃ¼
          INVALID_COLORS=$(grep "color:" ${{ env.LABELS_FILE }} | grep -vE "color: \"[0-9a-fA-F]{6}\"" | wc -l || true)
          if [ "$INVALID_COLORS" -eq 0 ]; then
            echo "âœ… Renk FormatÄ±: GeÃ§erli" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Renk FormatÄ±: HatalÄ± - $INVALID_COLORS geÃ§ersiz renk" >> $GITHUB_STEP_SUMMARY
          fi