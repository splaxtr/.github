name: Reusable Node.js CI Workflow

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "20.x"
      working-directory:
        description: "Directory to run the workflow in"
        required: false
        type: string
        default: "."
      run-tests:
        description: "Run tests (true/false)"
        required: false
        type: boolean
        default: true

    secrets:
      NPM_TOKEN:
        description: "NPM token for authentication"
        required: false

jobs:
  node-ci:
    name: Node.js CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      # ğŸ§¹ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ§± Setup Node.js
      - name: Setup Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      # ğŸ” Configure npm for private packages
      - name: Setup NPM authentication
        if: ${{ secrets.NPM_TOKEN != '' }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      # ğŸ“¦ Install dependencies
      - name: Install dependencies
        run: npm ci

      # ğŸ§ª Run tests
      - name: Run tests
        if: ${{ inputs.run-tests == 'true' }}
        run: npm test

      # ğŸ—ï¸ Build project
      - name: Build project
        run: npm run build --if-present

      # ğŸ³ Docker build and test
      - name: Build Docker image
        run: |
          docker build -t example-node:${{ github.sha }} .

      - name: Test Docker container
        run: |
          docker run --rm example-node:${{ github.sha }} node -v

      # ğŸ“¤ Upload build artifacts (if any)
      - name: Upload build artifacts
        if: ${{ always() && hashFiles('dist/**') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: node-build-${{ github.sha }}
          path: dist/

      # ğŸ§¾ Summary
      - name: Build Summary
        run: |
          echo "âœ… Node.js version: $(node -v)"
          echo "ğŸ“¦ NPM version: $(npm -v)"
          echo "ğŸ—ï¸ Build completed for ${{ inputs.working-directory }}"